# Seem to be required for LTO
# https://bugzilla.mozilla.org/show_bug.cgi?id=1480005
# https://bugzilla.mozilla.org/show_bug.cgi?id=1539280
export CC=clang
export CXX=clang++
export AR=llvm-ar
export RANLIB=llvm-ranlib
export NM=llvm-nm

# https://serge-sans-paille.github.io/pythran-stories/shrinking-a-shared-library.html
# https://news.ycombinator.com/item?id=36446158
export MORE_FLAGS="-fno-unwind-tables \
    -fno-exceptions \
    -fno-asynchronous-unwind-tables \
    -fomit-frame-pointer \
    -ffunction-sections \
    -fdata-sections \
    -Wl,--gc-sections \
    -Wl,--as-needed \
    -Wl,--icf=all \
    -fno-semantic-interposition \
    -Bsymbolic \
    -fno-stack-protector"
export CFLAGS="$CFLAGS $MORE_FLAGS"
export CXXFLAGS="$CXXFLAGS $MORE_FLAGS"
export RUSTFLAGS="$RUSTFLAGS -C opt-level=z"

# A fix for some issues in static linking
export LDFLAGS="$LDFLAGS -Wl,--allow-multiple-definition -Wl,--lto-O2"

export MOZILLA_OFFICIAL=1

mk_add_options MOZ_OBJDIR=@TOPSRCDIR@/obj-firefox

# Only build JS and xpcshell
# ac_add_options --enable-project=js

ac_add_options --disable-debug
ac_add_options --disable-debug-symbols
ac_add_options --disable-tests
ac_add_options --enable-strip
ac_add_options --enable-release
ac_add_options --enable-optimize=-Oz
ac_add_options --enable-lto=full
ac_add_options --enable-linker=lld
ac_add_options --enable-install-strip

# Some options to reduce the size of libjs
ac_add_options --disable-jit
ac_add_options --disable-spidermonkey-telemetry
# ac_add_options --disable-shared-js
# ac_add_options --disable-export-js
ac_add_options --disable-ctypes
ac_add_options --disable-shared-memory
ac_add_options --disable-wasm-multi-value
ac_add_options --disable-wasm-reftypes

ac_add_options --disable-sandbox
ac_add_options --disable-crashreporter
ac_add_options --disable-dmd
ac_add_options --disable-geckodriver
ac_add_options --disable-jprof
ac_add_options --disable-profiling

ac_add_options --disable-gtest-in-build
ac_add_options --disable-accessibility
ac_add_options --disable-av1
ac_add_options --disable-pref-extensions
ac_add_options --disable-printing
ac_add_options --disable-pulseaudio
ac_add_options --disable-startupcache
ac_add_options --disable-synth-speechd
ac_add_options --disable-webspeech
ac_add_options --disable-webspeechtestbackend
ac_add_options --disable-wmf
